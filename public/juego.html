<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Runa Defenders: La Furia del Grano</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        :root {
            --game-bg: #5c7e3a;
            --ui-bg: #4a2e1a;
            --text-light: #fdfbf8;
            --accent-color: #D47500;
            --bar-bg: #3a2e2a;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1310;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow: hidden;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            aspect-ratio: 9 / 16;
            background: var(--game-bg);
            border: 8px solid var(--ui-bg);
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        #game-canvas {
            width: 100%;
            height: 100%;
            display: block;
            background-image: url('https://www.transparenttextures.com/patterns/grass-cubes.png');
        }

        #ui-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 10;
            pointer-events: none;
        }
        
        .resource-bag {
            display: flex;
            align-items: center;
            background-color: var(--ui-bg);
            padding: 5px 10px;
            border-radius: 8px;
            border: 3px solid #6d4c35;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            pointer-events: all;
        }

        .resource-bag img {
            width: 25px;
            height: 30px;
            margin-right: 8px;
        }

        .resource-bag .resource-value {
            font-size: 16px;
            color: var(--text-light);
            text-shadow: 2px 2px #000;
        }
        
        .power-bar-container {
            width: 100px;
            height: 15px;
            background-color: var(--bar-bg);
            border-radius: 5px;
            overflow: hidden;
            border: 2px solid #6d4c35;
        }
        
        .power-bar {
            width: 0%;
            height: 100%;
            background-color: var(--accent-color);
            transition: width 0.2s linear;
        }

        #power-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: all;
        }

        .power-button {
            width: 50px;
            height: 50px;
            border: 3px solid #6d4c35;
            border-radius: 8px;
            background-color: var(--bar-bg);
            cursor: pointer;
            position: relative;
            opacity: 0.5;
            transition: opacity 0.3s, transform 0.1s;
        }
        .power-button.ready {
            opacity: 1;
            border-color: var(--accent-color);
        }
        .power-button.ready:hover {
            transform: scale(1.1);
        }
        .power-button img {
            width: 100%;
            height: 100%;
            padding: 5px;
        }

        #game-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            text-align: center;
            color: white;
            padding: 20px;
        }
        
        #game-overlay h1 {
            font-size: 6vw;
            margin-bottom: 20px;
            color: var(--accent-color);
            text-shadow: 4px 4px #000;
        }
        
        #game-overlay p {
            font-size: 3vw;
            max-width: 80%;
            line-height: 1.5;
        }

        .game-button {
            font-family: 'Press Start 2P', cursive;
            font-size: 4vw;
            padding: 15px 30px;
            background: var(--accent-color);
            border: none;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 30px;
            text-shadow: 2px 2px #000;
            border-bottom: 5px solid #a15a00;
            transition: all 0.1s ease;
        }
        
        .game-button:active {
            transform: translateY(3px);
            border-bottom-width: 2px;
        }

        #level-display {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            text-shadow: 2px 2px #000;
            pointer-events: none;
            background: rgba(0,0,0,0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            <div id="ui-panel">
                <div id="resource-bags" style="display: flex; flex-direction: column; gap: 10px;">
                    <div id="grains-bag" class="resource-bag">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCAxMDAiPjxwYXRoIGQ9Ik0xMCAwaDYwdjEwMGgtNjB6IiBmaWxsPSIjODQ1YzQyIi8+PHBhdGggZD0iTTEwIDBoNjBsLTEwIDEwaC00MGwtMTAgLTEweiIgZmlsbD0iIzY5NGI0MSIvPjwvc3ZnPg==" alt="Bolsa de Granos">
                        <span id="grains-value" class="resource-value">100</span>
                    </div>
                    <div id="power-bag" class="resource-bag">
                        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MCAxMDAiPjxwYXRoIGQ9Ik0xMCAwaDYwdjEwMGgtNjB6IiBmaWxsPSIjNjkzMDhmIi8+PHBhdGggZD0iTTEwIDBoNjBsLTEwIDEwaC00MGwtMTAgLTEweiIgZmlsbD0iIzU0MjY4NyIvPjwvc3ZnPg==" alt="Bolsa de Poder">
                        <div class="power-bar-container">
                            <div id="power-bar" class="power-bar"></div>
                        </div>
                    </div>
                </div>
                <div id="power-buttons">
                </div>
            </div>
            <div id="level-display"></div>
            <div id="game-overlay">
                <h1>Runa Defenders</h1>
                <p>¡Las plagas atacan! Protege tu Árbol de Café. Mueve a tu Grano Guardián, dispara a los enemigos y recolecta los Granos que caen para mejorar tus habilidades.</p>
                <button id="start-button" class="game-button">Empezar</button>
            </div>
        </div>
    </div>
    
<script>
    const config = {
        lanes: 5, initialLanes: 3, playerSpeed: 5, projectileSpeed: 8, shootCooldown: 20, 
        grainSpawnRate: 600, 
        powerBarMax: 100, orbValue: 20, 
        player: {
            image: {
                idle: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzY1NDMyMSIvPjxwYXRoIGQ9Ik0zMCA1MEE0MCA0MCAwIDAgMCA3MCA1MCIgZmlsbD0iIzM4MjIyMiIvPjwvc3ZnPg==',
                attack: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0MCIgZmlsbD0iIzk5NmI1MCIvPjxwYXRoIGQ9Ik0zMCA1MEE0MCA0MCAwIDAgMCA3MCA1MCIgZmlsbD0iIzM4MjIyMiIvPjwvc3ZnPg=='
            },
            projectileImage: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCAyMCI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iOCIgZmlsbD0iI2Q0NzUwMCIvPjwvc3ZnPg=='
        },
        tree: {
            image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgOTVsLTE1LTQwaC0xMHYtMTBoMjB2MTBoLTVsMTAtMzBoNWw5IDMwaC00di0xMGgyMHYxMGgtMTBsLTE1IDQwWiIgZmlsbD0iIzU0ODgyYSIvPjxwYXRoIGQ9Ik01MCA1NWgtMjVsMTAtMzBoNWwxMCAzMFoiIGZpbGw9IiM2YmE0MzQiLz48L3N2Zz4=',
            health: 1000
        },
        grainImage: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCAzMCI+PGVsbGlwc2UgY3g9IjEwIiBjeT0iMTUiIHJ4PSI4IiByeT0iMTQiIGZpbGw9IiM2NTQzMjEiLz48L3N2Zz4=',
        orbImage: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMCAyMCI+PGNpcmNsZSBjeD0iMTAiIGN5PSIxMCIgcj0iMTAiIGZpbGw9IiNmZGUwNDciLz48L3N2Zz4=',
        enemies: [
            { name: 'Broca Débil', health: 20, speed: 0.8, image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0iI2M3M2EzYSIvPjwvc3ZnPg==' },
            { name: 'Broca Normal', health: 60, speed: 0.6, image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0iI2M3N2IzYSIvPjwvc3ZnPg==' },
            { name: 'Broca Fuerte', health: 300, speed: 0.4, image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cmVjdCB4PSIyMCIgeT0iMjAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgZmlsbD0iI2E4M2EzYSIvPjwvc3ZnPg==' },
        ],
        levels: [
            { goal: 20, enemyTypes: [0], spawnInterval: 120 },
            { goal: 30, enemyTypes: [0, 1], spawnInterval: 100 },
            { goal: 1, enemyTypes: [2], spawnInterval: 0 },
        ]
    };

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    const container = document.getElementById('game-container');
    const gameOverlay = document.getElementById('game-overlay');
    const grainsValue = document.getElementById('grains-value');
    const powerBar = document.getElementById('power-bar');
    const levelDisplay = document.getElementById('level-display');

    let cellSize, cellGap = 5;
    let frame = 0;
    let gameState = 'start';
    let activeLanes = config.initialLanes;
    let player, tree;
    let projectiles = [], enemies = [], resources = [];
    let currentLevelIndex = 0;
    let enemiesToSpawnThisLevel = 0;
    let enemiesDefeatedThisLevel = 0;
    let spawnTimer = 0;
    let shootTimer = 0;
    let grainPoints = 0;
    let powerPoints = 0;
    let animationFrameId;

    const sounds = {
        shoot: new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination(),
        collectGrain: new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination(),
        collectOrb: new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0, release: 0.3 } }).toDestination(),
        enemyHit: new Tone.NoiseSynth({ noise: { type: 'pink' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.05 } }).toDestination(),
        gameOver: new Tone.Synth().toDestination(),
        levelUp: new Tone.Synth().toDestination(),
    };

    function playSound(sound, note, duration = '8n') {
        if (Tone.context.state !== 'running') { Tone.start().catch(console.error); }
        if (sounds[sound]) {
            try {
                if (note) sounds[sound].triggerAttackRelease(note, duration);
                else sounds[sound].triggerAttackRelease(0.1);
            } catch (e) { console.error("Error al reproducir sonido:", e) }
        }
    }

    class Player {
        constructor() { this.reset(); }
        reset() {
            this.width = cellSize * 0.9;
            this.height = cellSize * 0.9;
            this.x = canvas.width / 2 - this.width / 2;
            this.y = canvas.height - this.height - 50;
            this.speed = config.playerSpeed;
            this.image = new Image();
            this.image.src = config.player.image.idle;
            this.attackImage = new Image();
            this.attackImage.src = config.player.image.attack;
            this.isAttacking = false;
        }
        draw() {
            const currentImage = this.isAttacking ? this.attackImage : this.image;
            ctx.drawImage(currentImage, this.x, this.y, this.width, this.height);
        }
        update() {
            const leftLimit = (canvas.width - activeLanes * cellSize) / 2;
            const rightLimit = leftLimit + activeLanes * cellSize - this.width;
            if (this.x < leftLimit) this.x = leftLimit;
            if (this.x > rightLimit) this.x = rightLimit;
        }
        shoot() {
            if (shootTimer > 0 || gameState !== 'playing') return;
            projectiles.push(new Projectile(this.x + this.width / 2, this.y));
            shootTimer = config.shootCooldown;
            playSound('shoot', 'C5', '16n');
            this.isAttacking = true;
            setTimeout(() => this.isAttacking = false, 100);
        }
    }

    class Projectile {
        constructor(x, y) {
            this.x = x - 10;
            this.y = y;
            this.width = 20;
            this.height = 20;
            this.speed = config.projectileSpeed;
            this.power = 20;
            this.image = new Image();
            this.image.src = config.player.projectileImage;
        }
        update() { this.y -= this.speed; }
        draw() { ctx.drawImage(this.image, this.x, this.y, this.width, this.height); }
    }

    class Enemy {
        constructor(lane, typeIndex) {
            this.type = config.enemies[typeIndex];
            const leftOffset = (canvas.width - activeLanes * cellSize) / 2;
            this.x = leftOffset + (lane * cellSize) + cellGap;
            this.y = -cellSize;
            this.width = cellSize - cellGap * 2;
            this.height = cellSize - cellGap * 2;
            this.speed = this.type.speed;
            this.health = this.type.health;
            this.maxHealth = this.health;
            this.image = new Image();
            this.image.src = this.type.image;
        }
        update() { this.y += this.speed; }
        draw() { 
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
            if (this.health < this.maxHealth) {
                ctx.fillStyle = 'red';
                ctx.fillRect(this.x, this.y - 10, this.width, 5);
                ctx.fillStyle = 'green';
                ctx.fillRect(this.x, this.y - 10, this.width * (this.health / this.maxHealth), 5);
            }
        }
    }

    class Resource {
        constructor(type) {
            this.x = Math.random() * canvas.width;
            this.y = 0;
            this.size = 30;
            this.speedY = 1;
            this.type = type;
            this.image = new Image();
            this.image.src = type === 'grain' ? config.grainImage : config.orbImage;
            this.life = 400;
        }
        update() {
            this.y += this.speedY;
            this.life--;
        }
        draw() {
            ctx.globalAlpha = this.life < 60 ? this.life / 60 : 1;
            ctx.drawImage(this.image, this.x, this.y, this.size, this.size);
            ctx.globalAlpha = 1;
        }
    }

    class Tree {
        constructor() { this.reset(); }
        reset() {
            this.width = canvas.width;
            this.height = cellSize * 2;
            this.x = 0;
            this.y = canvas.height - this.height;
            this.health = config.tree.health;
            this.image = new Image();
            this.image.src = config.tree.image;
        }
        draw() {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        }
    }

    function isColliding(a, b) {
        return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
    }

    function handleGameLogic() {
        if (shootTimer > 0) shootTimer--;
        projectiles.forEach((p, i) => {
            p.update();
            if (p.y < 0) projectiles.splice(i, 1);
        });
        enemies.forEach(e => e.update());
        resources.forEach((r, i) => {
            r.update();
            if (r.life <= 0 || r.y > canvas.height) resources.splice(i, 1);
        });
        if (frame % config.grainSpawnRate === 0) resources.push(new Resource('grain'));
        
        handleCollisions();
        handleLevelProgression();
    }

    function handleCollisions() {
        for (let i = projectiles.length - 1; i >= 0; i--) {
            for (let j = enemies.length - 1; j >= 0; j--) {
                if (projectiles[i] && enemies[j] && isColliding(projectiles[i], enemies[j])) {
                    enemies[j].health -= projectiles[i].power;
                    projectiles.splice(i, 1);
                    playSound('enemyHit');
                    if (enemies[j].health <= 0) {
                        enemies.splice(j, 1);
                        enemiesDefeatedThisLevel++;
                        if (currentLevelIndex > 0) {
                            resources.push(new Resource('orb'));
                        }
                    }
                    break; 
                }
            }
        }
        for (let i = enemies.length - 1; i >= 0; i--) {
            if (enemies[i].y > canvas.height - cellSize) {
                tree.health -= 10;
                enemies.splice(i, 1);
                if (tree.health <= 0) {
                    gameState = 'game_over';
                    playSound('gameOver', 'C3', '1n');
                }
            }
        }
    }

    function handleLevelProgression() {
        if (gameState !== 'playing') return;
        const currentLevel = config.levels[currentLevelIndex];
        if (enemiesDefeatedThisLevel >= currentLevel.goal) {
            startNextLevel();
            return;
        }
        if (spawnTimer > 0) {
            spawnTimer--;
        } else if (enemies.length < 10) {
            spawnEnemy();
            spawnTimer = currentLevel.spawnInterval;
        }
    }

    function startNextLevel() {
        gameState = 'level_transition';
        currentLevelIndex++;
        if (currentLevelIndex >= config.levels.length) {
            gameState = 'game_over'; // Victory
            return;
        }
        enemies.length = 0;
        projectiles.length = 0;
        enemiesDefeatedThisLevel = 0;
        if (currentLevelIndex === 4) activeLanes = 4;
        if (currentLevelIndex === 8) activeLanes = 5;
        resizeCanvas();
        playSound('levelUp', 'G5', '4n');
        setTimeout(() => {
            gameState = 'playing';
        }, 2000);
    }

    function spawnEnemy() {
        const currentLevel = config.levels[currentLevelIndex];
        const enemyTypeIndex = currentLevel.enemyTypes[Math.floor(Math.random() * currentLevel.enemyTypes.length)];
        const lane = Math.floor(Math.random() * activeLanes);
        enemies.push(new Enemy(lane, enemyTypeIndex));
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const leftOffset = (canvas.width - activeLanes * cellSize) / 2;
        for (let i = 0; i < activeLanes; i++) {
            ctx.fillStyle = i % 2 === 0 ? 'rgba(0,0,0,0.05)' : 'rgba(0,0,0,0.1)';
            ctx.fillRect(leftOffset + i * cellSize, 0, cellSize, canvas.height);
        }
        tree.draw();
        player.draw();
        projectiles.forEach(p => p.draw());
        enemies.forEach(e => e.draw());
        resources.forEach(r => r.draw());
        grainsValue.textContent = grainPoints;
        powerBar.style.width = `${powerPoints}%`;
        levelDisplay.textContent = `Nivel: ${currentLevelIndex + 1}`;
    }

    function gameLoop() {
        if (gameState === 'start') return;
        if(gameState === 'playing') handleGameLogic();
        draw();
        if (gameState !== 'game_over') {
            frame++;
            animationFrameId = requestAnimationFrame(gameLoop);
        } else {
            displayGameOver();
        }
    }

    function displayGameOver() {
        cancelAnimationFrame(animationFrameId);
        gameOverlay.style.display = 'flex';
        const title = document.createElement('h1');
        const msg = document.createElement('p');
        const btn = document.createElement('button');
        btn.className = 'game-button';
        btn.textContent = 'Volver a Intentar';
        btn.onclick = init;
        if (tree.health <= 0) {
            title.textContent = '¡El Árbol ha Caído!';
            msg.textContent = 'Las plagas han destruido tu cafetal.';
        } else {
            title.textContent = '¡VICTORIA!';
            msg.textContent = '¡Has protegido el cafetal!';
        }
        gameOverlay.innerHTML = '';
        gameOverlay.append(title, msg, btn);
    }

    function init() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        resizeCanvas();
        player = new Player();
        tree = new Tree();
        activeLanes = config.initialLanes;
        currentLevelIndex = 0;
        enemiesDefeatedThisLevel = 0;
        enemies = [];
        projectiles = [];
        resources = [];
        grainPoints = 100;
        powerPoints = 0;
        gameState = 'start';
        gameOverlay.style.display = 'flex';
        const title = document.createElement('h1');
        title.textContent = 'Runa Defenders';
        const p = document.createElement('p');
        p.textContent = '¡Las plagas atacan! Protege tu Árbol de Café. Mueve a tu Grano Guardián, dispara a los enemigos y recolecta los Granos que caen para mejorar tus habilidades.';
        const startBtn = document.createElement('button');
        startBtn.className = 'game-button';
        startBtn.textContent = 'Empezar';
        gameOverlay.innerHTML = '';
        gameOverlay.append(title, p, startBtn);
        
        startBtn.onclick = () => {
            if (Tone.context.state !== 'running') { Tone.start(); }
            gameState = 'playing';
            gameOverlay.style.display = 'none';
            startNextLevel();
            gameLoop();
        };
    }

    let keys = {};
    window.addEventListener('keydown', e => { keys[e.key] = true; if (e.key === ' ') e.preventDefault(); });
    window.addEventListener('keyup', e => keys[e.key] = false);

    let touchX = null;
    let isDragging = false;
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        if (y > player.y && y < player.y + player.height && x > player.x && x < player.x + player.width) {
            isDragging = true;
            touchX = x - player.x;
        } else {
            player.shoot();
            checkResourceClick(x, y);
        }
    }, { passive: false });
    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!isDragging) return;
        const touch = e.touches[0];
        const rect = canvas.getBoundingClientRect();
        player.x = touch.clientX - rect.left - touchX;
    }, { passive: false });
    canvas.addEventListener('touchend', e => { isDragging = false; });
    canvas.addEventListener('click', e => {
        const rect = canvas.getBoundingClientRect();
        checkResourceClick(e.clientX - rect.left, e.clientY - rect.top);
    });

    function checkResourceClick(x, y) {
        for (let i = resources.length - 1; i >= 0; i--) {
            const r = resources[i];
            const dist = Math.sqrt((x - (r.x + r.size/2))**2 + (y - (r.y + r.size/2))**2);
            if (dist < r.size) {
                if (r.type === 'grain') {
                    grainPoints += 10;
                    playSound('collectGrain', 'G5');
                } else {
                    powerPoints = Math.min(config.powerBarMax, powerPoints + config.orbValue);
                    playSound('collectOrb', 'A4');
                }
                resources.splice(i, 1);
                break;
            }
        }
    }

    function controlLoop() {
        if (gameState === 'playing') {
            if (keys['a'] || keys['ArrowLeft']) player.x -= player.speed;
            if (keys['d'] || keys['ArrowRight']) player.x += player.speed;
            if (keys[' ']) player.shoot();
            player.update();
        }
        requestAnimationFrame(controlLoop);
    }
    
    function resizeCanvas() {
        const { width, height } = container.getBoundingClientRect();
        canvas.width = width;
        canvas.height = height;
        cellSize = width / config.lanes;
        if (player) player.reset();
        if (tree) tree.reset();
    }

    window.addEventListener('resize', resizeCanvas);
    init();
    controlLoop();
</script>

</body>
</html>
