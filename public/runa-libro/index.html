<!doctype html>
<html lang="es" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runa Libro Interactivo - RUNA Coffee</title>

    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="RUNA Coffee - Mi Runa Libro Interactivo" />
    <meta property="og:description" content="¡Bienvenido a RUNA Coffee! Te invito a explorar mi Runa Libro digital. Una experiencia para despertar los sentidos." />
    <!-- NOTE: This OG image should be an absolute URL to work on social media -->
    <meta property="og:image" content="https://raw.githubusercontent.com/Yanzsmartwood2025/Runacoffee/main/public/assets/imagenes/portada-libro.jpg" />
    <meta property="og:url" content="https://URL-DE-TU-PAGINA-AQUI.com" />
    <meta property="og:type" content="website" />
    
    <!-- External Libraries -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600;700&family=Roboto:wght@400;700&family=Lato&family=Montserrat&family=Oswald&family=Raleway&family=Merriweather&family=Playfair+Display&family=Lobster&family=Pacifico&family=Caveat&family=Indie+Flower&family=Shadows+Into+Light&family=Lora&display=swap" rel="stylesheet">
    
    <!-- Your Custom Stylesheet -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="no-tool-active">

<!-- Video de fondo -->
<div id="video-background-wrapper">
    <video id="video-background" autoplay loop muted playsinline>
        <!-- RUTA CORREGIDA -->
        <source id="video-source" src="../assets/videos/runa-fondo-video.mp4" type="video/mp4">
    </video>
</div>

<!-- Encabezado y Navegación -->
<header id="main-header" class="fixed top-0 left-0 right-0 z-40">
    <nav class="container mx-auto px-4 sm:px-6 py-2 flex justify-between items-center h-20">
        <!-- Controles Izquierdos -->
        <div class="flex-1 flex justify-start items-center space-x-2 sm:space-x-4">
            <button class="text-white p-2" id="menu-button" aria-label="Abrir menú">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <button id="theme-toggle" class="p-2 rounded-full text-white" aria-label="Cambiar tema de color">
                <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-1.414 8.486l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"/></svg>
                <svg id="theme-icon-moon" class="h-6 w-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            </button>
            <div id="auth-container" class="flex items-center">
                <!-- Contenido de autenticación (poblado por JS) -->
            </div>
        </div>
        <!-- Logo Central -->
        <div class="flex-shrink-0">
             <a href="index.html" class="h-16 w-16 flex items-center justify-center rounded-full overflow-hidden bg-white shadow-md">
                 <video autoplay loop muted playsinline class="w-full h-full object-contain">
                     <!-- RUTA CORREGIDA -->
                     <source src="../assets/videos/runa-logo-animado.mp4" type="video/mp4">
                 </video>
             </a>
        </div>
        <!-- Controles Derechos -->
        <div class="flex-1 flex justify-end items-center space-x-2 sm:space-x-4">
            <button id="video-skin-toggle" class="p-2 rounded-full text-white" aria-label="Abrir selector de video">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </button>
            <button id="mixer-toggle-button" class="w-9 h-9 rounded-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--runa-primary)]" aria-label="Abrir mezclador de ambiente">
                <video autoplay loop muted playsinline class="w-full h-full object-cover">
                    <!-- RUTA CORREGIDA -->
                    <source src="../assets/videos/runa-equalizer-video.mp4" type="video/mp4">
                </video>
            </button>
            <div id="cart-icon-wrapper" class="relative">
                <button id="open-cart-button" class="p-1 text-white" aria-label="Abrir carrito">
                   <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                   <span id="cart-counter" class="hidden">0</span>
                </button>
            </div>
        </div>
    </nav>
    <!-- Paneles Desplegables -->
    <div id="main-menu" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4 text-white">
             <div class="menu-section">
                 <div class="menu-section-header">
                     <span>Herramientas Creativas</span>
                     <i class="fas fa-chevron-down"></i>
                 </div>
                 <div class="menu-section-content">
                     <div class="tool-grid">
                         <div class="tool-button" id="tool-pencil" title="Lápiz"><i class="fas fa-pencil"></i><span>Lápiz</span></div>
                         <div class="tool-button" id="tool-text" title="Texto"><i class="fas fa-font"></i><span>Texto</span></div>
                         <div class="tool-button" id="tool-eraser" title="Borrador"><i class="fas fa-eraser"></i><span>Borrador</span></div>
                         <div class="tool-button" id="tool-upload" title="Subir Imagen"><i class="fas fa-image"></i><span>Foto</span></div>
                         <div class="tool-button" id="tool-clear" title="Limpiar Página"><i class="fas fa-trash"></i><span>Limpiar</span></div>
                         <div class="tool-button" id="tool-color" title="Color"><i class="fas fa-palette"></i><span>Color</span></div>
                         <div class="tool-button" id="tool-add-page" title="Añadir Hoja"><i class="fas fa-plus-circle"></i><span>Añadir</span></div>
                     </div>
                     <div id="color-picker-container">
                         <div class="color-picker-layout">
                             <canvas id="color-wheel" width="150" height="150"></canvas>
                             <div class="flex flex-col items-center gap-4">
                                 <div id="color-preview"></div>
                                 <input type="range" id="luminosity-slider" min="0" max="100" value="50" class="styled-slider">
                             </div>
                         </div>
                     </div>
                     <div class="mt-4">
                         <label for="line-width-slider" class="flex items-center gap-2 text-sm mb-2"><i class="fas fa-pen-nib"></i><span>Grosor</span></label>
                         <input type="range" id="line-width-slider" min="1" max="50" value="5" class="styled-slider">
                     </div>
                     <div id="font-selector-container" class="hidden mt-4">
                         <label class="flex items-center gap-2 text-sm mb-2"><i class="fas fa-font"></i><span>Tipografía</span></label>
                         <div id="font-palette"></div>
                     </div>
                 </div>
             </div>
             <div class="menu-section">
                 <div class="menu-section-header">
                     <span>Utilidades</span>
                     <i class="fas fa-chevron-down"></i>
                 </div>
                 <div class="menu-section-content">
                     <div class="tool-grid">
                         <div class="tool-button" id="tool-calc" title="Calculadora"><i class="fas fa-calculator"></i><span>Calc</span></div>
                         <div class="tool-button" id="tool-print" title="Imprimir"><i class="fas fa-print"></i><span>Imprimir</span></div>
                         <div class="tool-button" id="tool-share" title="Compartir"><i class="fas fa-share-nodes"></i><span>Compartir</span></div>
                     </div>
                 </div>
             </div>
        </div>
    </div>
    <div id="mixer-panel" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4">
            <h3 class="font-semibold text-lg mb-4 text-white">Mezclador de Ambiente</h3>
            <div id="sound-controls" class="space-y-4"></div>
        </div>
    </div>
    <div id="video-skin-panel" class="hidden absolute w-full shadow-lg border-t translucent-panel">
        <div class="container mx-auto px-6 py-4">
            <h3 class="font-semibold text-lg mb-4 text-white">Selector de Video de Fondo</h3>
            <div id="video-list" class="space-y-2"></div>
        </div>
    </div>
</header>

<!-- Contenido Principal: El Libro -->
<main>
    <div class="flipbook-viewport">
        <div class="flipbook-container">
            <div class="flipbook">
                <!-- Portada -->
                <div class="page hard cover-page" data-drawing-enabled="false"></div>

                <!-- Página 1: Título -->
                <div class="page" data-drawing-enabled="false">
                    <div class="content-wrapper flex flex-col justify-center items-center">
                        <h2 class="text-6xl text-center uppercase runa-coffee-title">RUNA COFFEE</h2>
                    </div>
                    <div class="page-number">1</div>
                </div>

                <!-- Páginas de Contenido -->
                <div class="page" data-drawing-enabled="false">
                    <div class="content-wrapper">
                        <h2 class="handwriting-title">La Historia de RUNA Coffee: Un Puente entre Mundos Sagrados ⚔️🌿</h2>
                        <p class="mb-4">Nació de una búsqueda profunda…</p>
                        <p class="mb-4">Desde hace ya muchos años por medio de una persona indimensionablemente trascendental en mi existencia, sentí una conexión con la fuerza ancestral de los pueblos vikingos: su sabiduría, su conexión con la naturaleza, sus símbolos sagrados grabados en piedra —las runas— que hablaban el lenguaje del alma. Esa mística me llamaba… pero algo no encajaba del todo con mi realidad: soy del corazón de Colombia, tierra de montañas y café.</p>
                        <h3>El Llamado del Norte 🌌</h3>
                        <ul>
                            <li class="mb-2">Me llamó la atención su fuerza, su valentía y su conexión con lo sagrado.</li>
                            <li class="mb-2">Me fascinaban sus runas: símbolos grabados que no solo eran letras, sino portales de sabiduría y poder espiritual.</li>
                            <li class="mb-2">También descubrí que los vikingos consumían hongos sagrados antes de entrar en batalla, no solo por fuerza, sino para conectarse con visiones, claridad y propósito.</li>
                            <li>Ellos no solo luchaban con el cuerpo, sino también con el alma despierta.</li>
                        </ul>
                    </div>
                    <div class="page-number">2</div>
                </div>

                <div class="page" data-drawing-enabled="false">
                    <div class="content-wrapper">
                        <h2 class="handwriting-title">La Revelación y el Nacimiento de RUNA Coffee 💡</h2>
                        <h3>La Raíz en Colombia ⛰️☕️</h3>
                        <p class="mb-4">Pero yo nací en Colombia, entre montañas, neblinas y cafetales.</p>
                        <p class="mb-4">Y me preguntaba: ¿Cómo puedo unir ese legado del norte con esta tierra fértil que llevo en mi sangre para la creación de mi marca de café?</p>
                        <h3>La Revelación: "Runa" ✨</h3>
                        <p class="mb-4">Investigando, encontré que en el idioma quechua, que hablan los indígenas, andinos y amazónicos, “runa” significa ser humano verdadero: un ser conectado con la madre tierra, con la comunidad y con su conciencia. Eso fue un llamado. ¡Una revelación!</p>
                        <p class="mb-4">La palabra runa estaba presente en ambos mundos:</p>
                        <ul>
                            <li class="mb-2">🌿 Los Andes, donde nací,</li>
                            <li>⚔️ Y El Norte, de donde me sentía espiritualmente heredera.</li>
                        </ul>
                        <h3>El Nacimiento de RUNA Coffee 🍄‍🟫</h3>
                        <p class="mb-4">Ahí nació Runa Coffee: Una marca que fusiona el café sagrado de nuestras montañas con los hongos ancestrales, como los hongos de poder que también usaban los vikingos.</p>
                        <p class="mb-4">No como escape, sino como medicina. Como ritual de enfoque, expansión y propósito.</p>
                        <p>Cada taza de Runa Coffee es un puente entre lo visible y lo invisible. Es un llamado al guerrero de luz que todos llevamos dentro. Es café con alma, con raíz, con visión. Un elixir para despertar, para sanar y para recordar quién eres.</p>
                    </div>
                    <div class="page-number">3</div>
                </div>

                <div class="page" data-drawing-enabled="false">
                    <div class="content-wrapper">
                        <h2 class="handwriting-title">¡De la tierra, con conciencia!</h2>
                        <p class="mb-4"><strong>Representa:</strong><br>Forma de vivir, sentir, y conectar con conciencia.</p>
                        <p class="mb-6"><strong>Runa:</strong><br>Es una palabra ancestral que en lenguas indígenas andinas significa 'Persona', 'Ser humano en plenitud' o 'Comunidad viva'.</p>
                        <h3>Valores que transmite la marca:</h3>
                        <ul>
                            <li class="mb-4"><strong>Autenticidad ancestral:</strong><br>RUNA honra nuestras raíces, es un tributo a la sabiduría de los pueblos originarios y su forma respetuosa de habitar el mundo.</li>
                            <li class="mb-4"><strong>Corazón con la tierra:</strong><br>Café cultivado con consciencia, en armonía y equilibrio con la naturaleza.</li>
                            <li class="mb-4"><strong>Vitalidad Pura:</strong><br>Energía natural, real, que no solo despierta el cuerpo, sino también el alma.</li>
                            <li><strong>Comunidad:</strong><br>Cada sorbo une historias, conocimiento, manos campesinas y propósitos.</li>
                        </ul>
                    </div>
                    <div class="page-number">4</div>
                </div>

                <div class="page" data-drawing-enabled="false">
                        <div class="content-wrapper">
                            <h3>Producción consciente:</h3>
                            <p>Cada grano es cultivado en armonía con el entorno, bajo prácticas éticas y sostenibles. Producido por manos locales que trabajan con amor, respeto y dignidad.</p>
                            <h3>Energía viva:</h3>
                            <p>Vitalidad real, sin artificios. Nuestro café especial consciente potencia la plenitud, la conexión con tu interior, equilibrio, autenticidad, salud, vida... propósito.</p>
                            <h3>Diseño con alma:</h3>
                            <p>Como diseñadora, cree un lenguaje visual que une lo que somos... Místicos, naturales, vivos. Cada empaque, símbolo y detalle tiene una intención.</p>
                            <h3>¿A quién va dirigido?</h3>
                            <p>A personas conscientes, exploradores, espirituales, creativos, que no solo buscan sabor sino sentido. A quienes valoran el origen, la historia, y el impacto de lo que consumen.</p>
                            <p class="signature mt-4">"Más que café, un llamado a despertar."</p>
                        </div>
                    <div class="page-number">5</div>
                </div>

                <!-- Páginas de Portal -->
                <div class="page portal-page" data-drawing-enabled="false">
                    <div class="content-wrapper">
                        <video class="portal-video" autoplay loop muted playsinline src="../assets/videos/runa-fondo-video.mp4"></video>
                        <div class="portal-overlay translucent-panel">
                            <div class="portal-content">
                                <h2>Tienda RUNA</h2>
                                <p>Descubre nuestra selección de cafés de especialidad, accesorios y más. Cada compra apoya a nuestras comunidades.</p>
                                <a href="tienda.html" class="portal-button">Ir a la Tienda</a>
                            </div>
                        </div>
                    </div>
                    <div class="page-number">6</div>
                </div>

                <div class="page portal-page" data-drawing-enabled="false">
                    <div class="content-wrapper">
                        <video class="portal-video" autoplay loop muted playsinline src="../assets/videos/runa_video_fondo_1.mp4"></video>
                        <div class="portal-overlay translucent-panel">
                             <div class="portal-content">
                                 <h2>Juego RUNA</h2>
                                 <p>Pon a prueba tus sentidos y sumérgete en el mundo de RUNA con nuestro juego interactivo. ¿Estás listo para el desafío?</p>
                                 <!-- RUTA DEFINITIVA CORREGIDA -->
                                 <a href="../RunaDefenders/index.html" class="portal-button">Jugar Ahora</a>
                             </div>
                        </div>
                    </div>
                    <div class="page-number">7</div>
                </div>

                <div class="page portal-page" data-drawing-enabled="false">
                   <div class="content-wrapper">
                        <video class="portal-video" autoplay loop muted playsinline src="../assets/videos/runa-intro.mp4"></video>
                        <div class="portal-overlay translucent-panel">
                             <div class="portal-content">
                                 <h2>Jusn38 Tech</h2>
                                 <p>Explora la innovación y el diseño detrás de esta experiencia. Jusn38 Tech, creando el futuro de las interacciones digitales.</p>
                                 <a href="jusn38.html" class="portal-button">Conocer Más</a>
                             </div>
                        </div>
                   </div>
                    <div class="page-number">8</div>
                </div>

                <!-- Páginas en Blanco para Dibujar -->
                <div class="page" data-drawing-enabled="true"><div class="page-number">9</div></div>
                <div class="page" data-drawing-enabled="true"><div class="page-number">10</div></div>

                <!-- Contraportada -->
                <div class="page hard" data-drawing-enabled="false"></div>
            </div>
            <div id="page-turn-hint">
                <i class="fas fa-hand-pointer"></i>
            </div>
        </div>
    </div>
</main>

<!-- Elementos Flotantes y Modales -->
<div id="visual-tool" class="hidden"></div>
<div id="cart-modal" class="fixed inset-0 z-50 flex items-end sm:items-center sm:justify-end p-0 sm:p-4 bg-black/60 hidden"></div>

<!-- Modal de Autenticación -->
<div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 hidden">
   <div class="translucent-panel w-full max-w-xs rounded-2xl shadow-2xl p-8 flex flex-col relative text-center">
        <button id="close-auth-modal-button" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors" aria-label="Cerrar modal">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <h2 class="text-2xl font-bold text-white mb-2">Bienvenido a Runa</h2>
        <p class="text-gray-400 mb-6">Inicia sesión o crea una cuenta</p>
        <button id="google-login-button-modal" class="w-full inline-flex items-center justify-center gap-3 px-4 py-2 text-base font-semibold text-gray-700 bg-white border border-transparent rounded-lg shadow-sm hover:bg-gray-200 transition-all">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C41.38,34.783,44,29.865,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            <span>Iniciar sesión con Google</span>
        </button>
   </div>
</div>

<!-- Calculadora -->
<div id="calculator">
    <div class="calculator-overlay">
        <div class="calc-header">
            <span class="calc-brand">TI-89 RUNA</span>
            <div class="flex items-center gap-4">
                <i id="calc-send" class="fas fa-paper-plane cursor-pointer hover:text-[var(--runa-primary)] transition-colors" title="Enviar a la página"></i>
                <i class="fas fa-xmark close-btn" id="calc-close" title="Cerrar"></i>
            </div>
        </div>
        <div class="calc-screen-container">
            <textarea id="calc-display" readonly rows="2"></textarea>
        </div>
        <div class="calc-keys">
            <button class="calc-btn func" data-func="Math.sin(">sin</button>
            <button class="calc-btn func" data-func="Math.cos(">cos</button>
            <button class="calc-btn func" data-func="Math.tan(">tan</button>
            <button class="calc-btn op" data-key="**">^</button>
            <button class="calc-btn func" data-func="Math.sqrt(">√</button>
            <button class="calc-btn func" data-func="Math.log10(">log</button>
            <button class="calc-btn func" data-func="Math.log(">ln</button>
            <button class="calc-btn op" data-key="(">(</button>
            <button class="calc-btn op" data-key=")">)</button>
            <button class="calc-btn op" data-key="/">÷</button>
            <button class="calc-btn num" data-key="7">7</button>
            <button class="calc-btn num" data-key="8">8</button>
            <button class="calc-btn num" data-key="9">9</button>
            <button class="calc-btn op" data-key="*">×</button>
            <button class="calc-btn clear" id="calc-backspace"><i class="fas fa-delete-left"></i></button>
            <button class="calc-btn num" data-key="4">4</button>
            <button class="calc-btn num" data-key="5">5</button>
            <button class="calc-btn num" data-key="6">6</button>
            <button class="calc-btn op" data-key="-">-</button>
            <button class="calc-btn clear" id="calc-clear">C</button>
            <button class="calc-btn num" data-key="1">1</button>
            <button class="calc-btn num" data-key="2">2</button>
            <button class="calc-btn num" data-key="3">3</button>
            <button class="calc-btn op" data-key="+">+</button>
            <button class="calc-btn enter calc-btn-enter" id="calc-equals">ENTER</button>
            <button class="calc-btn num calc-btn-zero" data-key="0">0</button>
            <button class="calc-btn num" data-key=".">.</button>
            <button class="calc-btn op" data-key="*(-1)">(-)</button>
        </div>
    </div>
</div>

<!-- Elementos de Audio -->
<audio id="river-audio" loop><source src="../assets/mp3/rio.mp3" type="audio/mpeg"></audio>
<audio id="birds-audio" loop><source src="../assets/mp3/pajaros.mp3" type="audio/mpeg"></audio>
<audio id="rain-audio" loop><source src="../assets/mp3/lluvia.mp3" type="audio/mpeg"></audio>
<audio id="fire-audio" loop><source src="../assets/mp3/fuego.mp3" type="audio/mpeg"></audio>
<audio id="wind-audio" loop><source src="../assets/mp3/viento.mp3" type="audio/mpeg"></audio>
<audio id="storm-audio" loop><source src="../assets/mp3/tormenta.mp3" type="audio/mpeg"></audio>

<!-- Tu Script Personalizado -->
<script type="module">
// Importa los servicios de Firebase que necesitarás
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// Se asegura de que el DOM esté completamente cargado antes de ejecutar el script
$(document).ready(function () {
    // --- Inicialización de Firebase (COMENTADA PARA PRUEBAS LOCALES) ---
    // const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
    // const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // const app = initializeApp(firebaseConfig);
    // const auth = getAuth(app);
    // const db = getFirestore(app);

    let currentUserId = "test-user";
    let isAuthReady = true;

    // --- Manejo de la Interfaz de Autenticación de Firebase ---
    const handleSignIn = () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
            .then((result) => {
                console.log("Inicio de sesión con Google exitoso", result.user);
                $('#auth-modal').addClass('hidden');
            }).catch((error) => {
                console.error("Error en el inicio de sesión con Google", error);
            });
    };

    const updateAuthUI = (user) => {
        const authContainer = $('#auth-container');
        authContainer.empty();

        if (user && !user.isAnonymous) {
            // RUTA CORREGIDA para la imagen de fallback
            const fallbackImage = '../assets/imagenes/logo-google.png';
            const photoURL = user.photoURL || fallbackImage;

            const userButton = $(`
                <button id="logout-button" class="w-9 h-9 rounded-full overflow-hidden focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--runa-primary)] flex items-center justify-center bg-white p-1" title="Cerrar sesión: ${user.displayName || 'Usuario'}">
                    <img src="${photoURL}" alt="${user.displayName || 'Usuario'}" class="w-full h-full ${user.photoURL ? 'object-cover' : 'object-contain'}" onerror="this.onerror=null;this.src='${fallbackImage}';">
                </button>
            `);

            userButton.on('click', () => {
                signOut(auth).catch(error => console.error("Error al cerrar sesión", error));
            });
            authContainer.append(userButton);

        } else {
            // RUTA CORREGIDA para la imagen de login
            const loginButton = $(`
                <button id="open-auth-modal-button" class="p-1 rounded-full text-white" aria-label="Abrir modal de inicio de sesión">
                    <img src="../assets/imagenes/logo-google.png" alt="Iniciar sesión" class="w-7 h-7">
                </button>
            `);
            loginButton.on('click', () => {
                $('#auth-modal').removeClass('hidden');
            });
            authContainer.append(loginButton);
        }
    };

    // onAuthStateChanged(auth, async (user) => {
    //     if (user) {
    //         currentUserId = user.uid;
    //     } else {
    //         try {
    //             const anonymousUser = await signInAnonymously(auth);
    //             currentUserId = anonymousUser.user.uid;
    //         } catch (error) {
    //             console.error("Falló el inicio de sesión anónimo:", error);
    //         }
    //     }
    //     isAuthReady = true;
    //     loadInitialPageData();
    //     updateAuthUI(user);
    // });

    // if (initialAuthToken) {
    //     signInWithCustomToken(auth, initialAuthToken).catch(err => {
    //         console.error("Falló el inicio de sesión con token personalizado, intentando anónimo.", err);
    //     });
    // }
    loadInitialPageData();
    updateAuthUI(null);

    $('#google-login-button-modal').on('click', handleSignIn);

    // --- Variables de Estado ---
    const flipbook = $('.flipbook');
    let currentTool = 'no-tool';
    let currentColor = 'rgb(0,0,0)';
    let baseColorFromWheel = { r: 0, g: 0, b: 0 };
    let currentLineWidth = 5;
    let isDrawing = false;
    let lastX = 0, lastY = 0;
    // RUTA CORREGIDA para el sonido
    const pageFlipSound = new Audio('../assets/mp3/page-flip.mp3');
    const visualTool = $('#visual-tool');

    // --- Constantes y Datos ---
    const fonts = [
        { name: 'Poppins', family: "'Poppins', sans-serif" }, { name: 'Roboto', family: "'Roboto', sans-serif" },
        { name: 'Lato', family: "'Lato', sans-serif" }, { name: 'Montserrat', family: "'Montserrat', sans-serif" },
        { name: 'Oswald', family: "'Oswald', sans-serif" }, { name: 'Raleway', family: "'Raleway', sans-serif" },
        { name: 'Merriweather', family: "'Merriweather', serif" }, { name: 'Playfair Display', family: "'Playfair Display', serif" },
        { name: 'Lora', family: "'Lora', serif" }, { name: 'Dancing Script', family: "'Dancing Script', cursive" },
        { name: 'Lobster', family: "'Lobster', cursive" }, { name: 'Pacifico', family: "'Pacifico', cursive" },
        { name: 'Caveat', family: "'Caveat', cursive" }, { name: 'Indie Flower', family: "'Indie Flower', cursive" },
        { name: 'Shadows Into Light', family: "'Shadows Into Light', cursive" },
    ];
    const videoSkins = [
        // RUTA CORREGIDA para el video
        { name: "Naturaleza y Café", url: "../assets/videos/runa-fondo-video.mp4" }
    ];
    let currentVideoIndex = 0;
    const ambienceSounds = [
        // RUTAS CORREGIDAS para los GIFs
        { id: 'river-audio', name: 'Río', gifSrc: '../assets/gif/river.gif' },
        { id: 'birds-audio', name: 'Pájaros', gifSrc: '../assets/gif/birds.gif' },
        { id: 'rain-audio', name: 'Lluvia', gifSrc: '../assets/gif/rain.gif' },
        { id: 'fire-audio', name: 'Fuego', gifSrc: '../assets/gif/fire.gif' },
        { id: 'wind-audio', name: 'Viento', gifSrc: '../assets/gif/wind.gif' },
        { id: 'storm-audio', name: 'Tormenta', gifSrc: '../assets/gif/storm.gif' },
    ];

    // --- Definiciones de Funciones (sin cambios en la lógica interna) ---
    function getCanvasForPage(pageNumber) {
        let canvas = $(`#canvas-page-${pageNumber}`);
        const pageElement = flipbook.find(`.page[data-page-number=${pageNumber}]`);
        if (!pageElement.length || pageElement.data('drawing-enabled') !== true) return null;
        if (canvas.length === 0) {
            canvas = $('<canvas>').addClass('drawing-canvas').attr('id', `canvas-page-${pageNumber}`);
            pageElement.append(canvas);
            const canvasEl = canvas[0];
            canvasEl.width = pageElement.width();
            canvasEl.height = pageElement.height();
            canvas.on('mousedown touchstart', startDrawing);
            canvas.on('mousemove touchmove', draw);
        }
        return canvas[0];
    }

    function getTextLayerForPage(pageNumber) {
        let textLayer = $(`#text-layer-page-${pageNumber}`);
        const pageElement = flipbook.find(`.page[data-page-number=${pageNumber}]`);
        if (!pageElement.length || pageElement.data('drawing-enabled') !== true) return null;
        if (textLayer.length === 0) {
            textLayer = $('<div>')
                .addClass('text-layer-container')
                .attr('id', `text-layer-page-${pageNumber}`)
                .attr('contenteditable', 'true')
                .attr('spellcheck', 'false');
            pageElement.append(textLayer);
            textLayer.on('input', () => saveTextForPage(pageNumber));
            textLayer.on('click', function() {
                if (currentTool !== 'text') setActiveTool('text');
            });
        }
        return textLayer[0];
    }

    function startDrawing(e) {
        if (currentTool !== 'pencil' && currentTool !== 'eraser') return;
        isDrawing = true;
        visualTool.show();
        const [x, y] = getCoords(e, $(e.target));
        [lastX, lastY] = [x, y];
        draw(e);
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const page = flipbook.turn('page');
        const canvas = getCanvasForPage(page);
        if (!canvas) return;
        const [x, y] = getCoords(e, $(canvas));
        const canvasRect = canvas.getBoundingClientRect();
        visualTool.css({ top: canvasRect.top + y, left: canvasRect.left + x });
        const ctx = canvas.getContext('2d');
        ctx.globalCompositeOperation = (currentTool === 'eraser') ? 'destination-out' : 'source-over';
        ctx.lineWidth = (currentTool === 'eraser') ? 25 : currentLineWidth;
        ctx.strokeStyle = currentColor;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.stroke();
        [lastX, lastY] = [x, y];
    }

    function stopDrawing() {
        if(isDrawing) {
            const page = flipbook.turn('page');
            saveDrawingForPage(page);
        }
        isDrawing = false;
        visualTool.hide();
    }

    function getCoords(e, target) {
        const rect = target[0].getBoundingClientRect();
        const event = e.originalEvent.touches ? e.originalEvent.touches[0] : e;
        return [event.clientX - rect.left, event.clientY - rect.top];
    }

    async function saveDrawingForPage(pageNumber) {
        if (!isAuthReady || !currentUserId) return;
        const canvas = getCanvasForPage(pageNumber);
        if (canvas) {
            const dataURL = canvas.toDataURL();
            try {
                const pageDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/runaLibroPages`, `page-${pageNumber}`);
                await setDoc(pageDocRef, { drawingData: dataURL }, { merge: true });
            } catch (e) { console.error("Error guardando el dibujo:", e); }
        }
    }

    async function loadDrawingForPage(pageNumber) {
        if (!isAuthReady || !currentUserId) return;
        const canvas = getCanvasForPage(pageNumber);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            try {
                const pageDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/runaLibroPages`, `page-${pageNumber}`);
                const docSnap = await getDoc(pageDocRef);
                if (docSnap.exists() && docSnap.data().drawingData) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0);
                    img.src = docSnap.data().drawingData;
                }
            } catch (e) { console.error("Error cargando el dibujo:", e); }
        }
    }

    async function saveTextForPage(pageNumber) {
        if (!isAuthReady || !currentUserId) return;
        const textLayer = getTextLayerForPage(pageNumber);
        if (textLayer) {
            try {
                const pageDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/runaLibroPages`, `page-${pageNumber}`);
                await setDoc(pageDocRef, { textData: textLayer.innerHTML }, { merge: true });
            } catch (e) { console.error("Error guardando el texto:", e); }
        }
    }

    async function loadTextForPage(pageNumber) {
        if (!isAuthReady || !currentUserId) return;
        const textLayer = getTextLayerForPage(pageNumber);
        if (textLayer) {
            textLayer.innerHTML = '';
            try {
                const pageDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/runaLibroPages`, `page-${pageNumber}`);
                const docSnap = await getDoc(pageDocRef);
                if (docSnap.exists() && docSnap.data().textData) {
                    textLayer.innerHTML = docSnap.data().textData;
                }
            } catch (e) { console.error("Error cargando el texto:", e); }
        }
    }

    async function loadInitialPageData() {
        const view = flipbook.turn('view');
        for (const p of view) {
            if (p > 0 && $(`.page[data-page-number=${p}]`).data('drawing-enabled')) {
                await loadDrawingForPage(p);
                await loadTextForPage(p);
            }
        }
    }

    function setActiveTool(tool) {
        $('.tool-button').removeClass('active');
        visualTool.removeClass('pencil eraser');
        $('body').removeClass('drawing-tool-active text-tool-active eraser-tool-active no-tool-active');
        currentTool = tool;
        if (tool === 'pencil') $('body').addClass('drawing-tool-active');
        else if (tool === 'eraser') $('body').addClass('eraser-tool-active');
        else if (tool === 'text') $('body').addClass('text-tool-active');
        else $('body').addClass('no-tool-active');
        $(`#tool-${tool}`).addClass('active');
        if (tool === 'text') {
            $('#font-selector-container').removeClass('hidden');
            $('#color-picker-container').addClass('hidden');
            visualTool.hide();
            const textLayer = getTextLayerForPage(flipbook.turn('page'));
            if (textLayer) {
                $(textLayer).focus();
                document.execCommand('foreColor', false, currentColor);
            }
        } else {
            $('#font-selector-container').addClass('hidden');
            if (tool === 'pencil' || tool === 'eraser') {
                visualTool.html(tool === 'pencil' ? '<i class="fas fa-pencil"></i>' : '<i class="fas fa-eraser"></i>').addClass(tool);
            } else {
                visualTool.hide();
            }
        }
    }

    function applyTheme(theme) {
        if (theme === 'dark') {
            $('html').removeClass('light').addClass('dark');
            $('#theme-icon-sun').show();
            $('#theme-icon-moon').hide();
        } else {
            $('html').removeClass('dark').addClass('light');
            $('#theme-icon-sun').hide();
            $('#theme-icon-moon').show();
        }
    }

    function closeAllPanels() {
        $('#main-menu, #mixer-panel, #video-skin-panel').addClass('hidden');
    }

    function initializeMixer() {
        const soundControlsContainer = $('#sound-controls');
        soundControlsContainer.html('');
        ambienceSounds.forEach(sound => {
            const audioEl = document.getElementById(sound.id);
            if (!audioEl) return;
            const controlHTML = `<div class="flex items-center gap-4 text-sm text-white"><button id="btn-${sound.id}" class="mixer-icon-button relative w-10 h-10 rounded-full shadow-md flex-shrink-0 overflow-hidden"><img src="${sound.gifSrc}" alt="${sound.name}"></button><span class="font-medium w-20 truncate">${sound.name}</span><input type="range" id="volume-${sound.id}" min="0" max="1" step="0.01" value="0" class="styled-slider" style="--thumb-color: var(--runa-primary); --track-fill-color: var(--slider-track-color);"></div>`;
            soundControlsContainer.append(controlHTML);
            const slider = $(`#volume-${sound.id}`);
            slider.on('input', function() {
                const newVolume = parseFloat($(this).val());
                audioEl.volume = newVolume;
                $(`#btn-${sound.id}`).toggleClass('active', newVolume > 0);
                updateSliderFill(this);
                if (newVolume > 0 && audioEl.paused) audioEl.play().catch(e => console.error(`Error al reproducir ${sound.id}:`, e));
                else if (newVolume === 0 && !audioEl.paused) audioEl.pause();
            });
            $(`#btn-${sound.id}`).on('click', function() {
                const currentVolume = parseFloat(slider.val());
                slider.val(currentVolume > 0 ? 0 : (slider.data('lastValue') || 0.5));
                if (currentVolume > 0) slider.data('lastValue', currentVolume);
                slider.trigger('input');
            });
            updateSliderFill(slider[0]);
        });
    }

    function setVideoSkin(index) {
        const video = $('#video-background');
        const source = $('#video-source');
        if(video.length && source.length){
            video.css('opacity', 0);
            setTimeout(() => {
                currentVideoIndex = index;
                source.attr('src', videoSkins[currentVideoIndex].url);
                video[0].load();
                video[0].play().catch(e => console.error("La reproducción del video falló:", e));
                video.css('opacity', 1);
                localStorage.setItem('runaVideoSkin', currentVideoIndex);
                updateVideoListUI();
            }, 500);
        }
    }

    function updateVideoListUI() {
        $('#video-list button').each(function(index) {
            $(this).toggleClass('active', index === currentVideoIndex);
        });
    }

    function initializeVideoSelector() {
        const videoListContainer = $('#video-list');
        videoListContainer.html('');
        videoSkins.forEach((skin, index) => {
            const button = $(`<button class="video-list-button w-full text-left p-2 rounded-lg transition-colors duration-200 text-white">${skin.name}</button>`);
            button.on('click', () => setVideoSkin(index));
            videoListContainer.append(button);
        });
        updateVideoListUI();
    }

    function renderCartModal() {
        const cartModal = $('#cart-modal');
        let contentHTML = `<div class="p-8 flex-grow flex flex-col items-center justify-center text-center"><svg class="w-16 h-16 text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><h3 class="font-semibold text-lg text-white">Tu carrito está vacío</h3><p class="text-sm text-gray-400">Añade productos para verlos aquí.</p></div>`;
        cartModal.html(`<div class="translucent-panel w-full max-w-sm h-full sm:h-auto sm:rounded-2xl shadow-2xl flex flex-col ml-auto"><header class="p-4 border-b border-white/10 flex justify-between items-center"><h2 class="text-xl font-bold text-white">Tu Carrito</h2><button id="close-cart-button" class="p-1 rounded-full text-white hover:bg-white/10 transition-colors"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button></header>${contentHTML}</div>`);
        $('#close-cart-button').on('click', () => $('#cart-modal').addClass('hidden'));
    }

    function updateSliderFill(slider) {
        const percent = (($(slider).val() - $(slider).attr('min')) / ($(slider).attr('max') - $(slider).attr('min'))) * 100;
        $(slider).css('--value-percent', `${percent}%`);
    }

    // --- Configuración Inicial y Manejadores de Eventos ---
    $('.flipbook .page').each((index, el) => $(el).attr('data-page-number', index + 1));
    $(window).on('mouseup touchend', stopDrawing);
    flipbook.turn({
        width: $('.flipbook-container').width(), height: $('.flipbook-container').height(),
        display: 'single', elevation: 50, gradients: true, autoCenter: true,
        when: {
            turning: async (event, page, view) => {
                if ($(`.page[data-page-number=${page}]`).data('drawing-enabled')) {
                    await saveDrawingForPage(page);
                    await saveTextForPage(page);
                }
            },
            turned: async (event, page, view) => {
                for (const p of view) {
                    if (p > 0 && $(`.page[data-page-number=${p}]`).data('drawing-enabled')) {
                        await loadDrawingForPage(p);
                        await loadTextForPage(p);
                    }
                }
                if(currentTool === 'text') getTextLayerForPage(page)?.focus();
                if (page > 1) {
                    pageFlipSound.currentTime = 2.2;
                    pageFlipSound.play().catch(console.error);
                    setTimeout(() => pageFlipSound.pause(), 1000);
                }
            }
        }
    });

    // --- Manejadores de Eventos de Herramientas ---
    $('#tool-pencil').on('click', () => { setActiveTool('pencil'); closeAllPanels(); });
    $('#tool-text').on('click', () => setActiveTool('text'));
    $('#tool-eraser').on('click', () => { setActiveTool('eraser'); closeAllPanels(); });
    $('#tool-clear').on('click', async () => {
        const page = flipbook.turn('page');
        const canvas = getCanvasForPage(page);
        if (canvas) {
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            await saveDrawingForPage(page);
        }
        const textLayer = getTextLayerForPage(page);
        if (textLayer) {
            textLayer.innerHTML = '';
            await saveTextForPage(page);
        }
        closeAllPanels();
    });
    $('#tool-calc').on('click', () => { $('#calculator').fadeToggle(); closeAllPanels(); });
    $('#tool-add-page').on('click', () => {
        const newPage = $('<div class="page" data-drawing-enabled="true"><div class="page-number"></div></div>');
        const book = $('.flipbook');
        book.turn('addPage', newPage, book.turn('pages') + 1);
        $('.flipbook .page').each(function(index) {
            $(this).attr('data-page-number', index + 1).find('.page-number').text(index + 1);
        });
        closeAllPanels();
    });

    $('#line-width-slider').on('input', function() {
        currentLineWidth = $(this).val();
        setActiveTool('pencil');
        updateSliderFill(this);
    });

    const fontPalette = $('#font-palette');
    fonts.forEach(font => {
        const fontButton = $(`<button class="font-button" style="font-family: ${font.family};">${font.name}</button>`);
        fontButton.data('fontFamily', font.family).on('click', function() {
            $('.font-button').removeClass('active');
            $(this).addClass('active');
            const page = flipbook.turn('page');
            const textLayer = getTextLayerForPage(page);
            if (textLayer) {
                document.execCommand('fontName', false, $(this).data('fontFamily'));
                $(textLayer).focus();
                saveTextForPage(page);
            }
            closeAllPanels();
        });
        fontPalette.append(fontButton);
    });
    fontPalette.find('button:first').addClass('active');

    $('#tool-print').on('click', () => { window.print(); closeAllPanels(); });

    $('#tool-share').on('click', async () => {
        try { await navigator.share({ title: 'RUNA Coffee - Runa Libro', text: '¡Te invito a explorar mi Runa Libro interactivo!', url: window.location.href }); }
        catch (err) { console.error("Falló la compartición:", err); }
        closeAllPanels();
    });

    $('<input type="file" id="image-uploader" accept="image/*" class="hidden">').appendTo('body').on('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = async () => {
                const page = flipbook.turn('page');
                const canvas = getCanvasForPage(page);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const maxW = canvas.width * 0.8, maxH = canvas.height * 0.8;
                    let w = img.width, h = img.height, ratio = w / h;
                    if (w > maxW) { w = maxW; h = w / ratio; }
                    if (h > maxH) { h = maxH; w = h * ratio; }
                    ctx.drawImage(img, (canvas.width - w) / 2, (canvas.height - h) / 2, w, h);
                    await saveDrawingForPage(page);
                }
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
        $(this).val('');
        closeAllPanels();
    });

    // --- Lógica del Selector de Color ---
    $('#tool-color').on('click', () => $('#color-picker-container').slideToggle());

    const colorWheel = document.getElementById('color-wheel');
    const colorPreview = document.getElementById('color-preview');
    const luminositySlider = document.getElementById('luminosity-slider');
    const cwCtx = colorWheel.getContext('2d');
    const wheelRadius = colorWheel.width / 2;
    cwCtx.translate(wheelRadius, wheelRadius);

    function drawColorWheel() {
        for (let angle = 0; angle < 360; angle++) {
            const startAngle = (angle - 2) * Math.PI / 180;
            const endAngle = angle * Math.PI / 180;
            cwCtx.beginPath(); cwCtx.moveTo(0, 0); cwCtx.arc(0, 0, wheelRadius, startAngle, endAngle); cwCtx.closePath();
            const gradient = cwCtx.createRadialGradient(0, 0, 0, 0, 0, wheelRadius);
            gradient.addColorStop(0, "white");
            gradient.addColorStop(1, `hsl(${angle}, 100%, 50%)`);
            cwCtx.fillStyle = gradient;
            cwCtx.fill();
        }
    }

    function updateFinalColor() {
        const lum = luminositySlider.value;
        let {r, g, b} = baseColorFromWheel;
        const lerp = (a, b, t) => a + (b - a) * t;
        const t = lum < 50 ? lum / 50 : (lum - 50) / 50;
        r = lum < 50 ? lerp(0, r, t) : lerp(r, 255, t);
        g = lum < 50 ? lerp(0, g, t) : lerp(g, 255, t);
        b = lum < 50 ? lerp(0, b, t) : lerp(b, 255, t);
        currentColor = `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
        colorPreview.style.backgroundColor = currentColor;
        if (currentTool === 'text') document.execCommand('foreColor', false, currentColor);
    }

    function pickColorFromWheel(e) {
        const rect = colorWheel.getBoundingClientRect();
        const x = e.clientX - rect.left - wheelRadius;
        const y = e.clientY - rect.top - wheelRadius;
        const pixel = cwCtx.getImageData(x + wheelRadius, y + wheelRadius, 1, 1).data;
        baseColorFromWheel = { r: pixel[0], g: pixel[1], b: pixel[2] };
        luminositySlider.style.setProperty('--track-fill-color', `rgb(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`);
        updateFinalColor();
    }

    $(colorWheel).on('mousedown', (e) => {
        pickColorFromWheel(e);
        $(colorWheel).on('mousemove', pickColorFromWheel);
    }).on('mouseup mouseleave', () => $(colorWheel).off('mousemove', pickColorFromWheel));

    $(luminositySlider).on('input', updateFinalColor);

    // --- Lógica de la Calculadora ---
    const calculator = $('#calculator');
    const calcDisplay = $('#calc-display');
    $('#calc-close').on('click', () => calculator.fadeOut());

    async function sendToPage(value) {
        if (value && value !== 'Error') {
            setActiveTool('text');
            const page = flipbook.turn('page');
            const textLayer = getTextLayerForPage(page);
            if (textLayer) {
                $(textLayer).focus();
                document.execCommand('insertText', false, ` ${value} `);
                await saveTextForPage(page);
            }
        }
    }

    $('#calc-send').on('click', () => {
        sendToPage(calcDisplay.val());
        calculator.fadeOut();
    });

    $('.calc-keys').on('click', '.calc-btn', function() {
        const key = $(this).data('key');
        const func = $(this).data('func');
        calcDisplay.val(calcDisplay.val() + (key !== undefined ? key : func));
    });

    $('#calc-clear').on('click', () => calcDisplay.val(''));
    $('#calc-backspace').on('click', () => calcDisplay.val(calcDisplay.val().slice(0, -1)));

    $('#calc-equals').on('click', () => {
        try {
            let expression = calcDisplay.val().replace(/\^/g, '**');
            const result = new Function('return ' + expression)();
            calcDisplay.val(result);
        } catch (e) { calcDisplay.val('Error'); }
    });

    // --- Manejadores de Eventos de la UI Principal ---
    $('#theme-toggle').on('click', () => {
        const newTheme = $('html').hasClass('dark') ? 'light' : 'dark';
        localStorage.setItem('runaTheme', newTheme);
        applyTheme(newTheme);
    });

    $('#menu-button, #mixer-toggle-button, #video-skin-toggle').on('click', function(e) {
        e.stopPropagation();
        const panelId = $(this).attr('id').replace('-button', '-panel').replace('toggle-', '');
        const wasOpen = !$(`#${panelId}`).hasClass('hidden');
        closeAllPanels();
        if (!wasOpen) $(`#${panelId}`).removeClass('hidden');
    });

    $(window).on('click', (e) => { if (!$(e.target).closest('#main-header').length) closeAllPanels(); });
    $('.menu-section-header').on('click', function() { $(this).toggleClass('active').next('.menu-section-content').slideToggle(); });

    $('#open-cart-button').on('click', () => { renderCartModal(); $('#cart-modal').removeClass('hidden'); });
    $('#cart-modal').on('click', (event) => { if (event.target === $('#cart-modal')[0]) $('#cart-modal').addClass('hidden'); });
    $('#close-auth-modal-button').on('click', () => $('#auth-modal').addClass('hidden'));

    $(window).on('resize', () => {
        flipbook.turn('size', $('.flipbook-container').width(), $('.flipbook-container').height());
        $('.flipbook .page').each(function() {
            const canvas = getCanvasForPage($(this).data('page-number'));
            if (canvas) {
                canvas.width = $(this).width();
                canvas.height = $(this).height();
                loadDrawingForPage($(this).data('page-number'));
            }
        });
    }).trigger('resize');

    // --- Inicializaciones Finales ---
    const pageTurnHint = $('#page-turn-hint');
    if (localStorage.getItem('runaHintSeen') !== 'true') {
        setTimeout(() => pageTurnHint.addClass('visible'), 1500);
        flipbook.one('turned', () => { pageTurnHint.removeClass('visible'); localStorage.setItem('runaHintSeen', 'true'); });
    }

    setActiveTool('no-tool');
    applyTheme(localStorage.getItem('runaTheme') || 'light');
    initializeMixer();
    initializeVideoSelector();
    setVideoSkin(parseInt(localStorage.getItem('runaVideoSkin')) || 0);
    $('#line-width-slider').css('--thumb-color', 'var(--pencil-track-color)').css('--track-fill-color', 'var(--pencil-track-color)');
    updateSliderFill($('#line-width-slider')[0]);
    drawColorWheel();
    colorPreview.style.backgroundColor = currentColor;
});
</script>

</body>
</html>
